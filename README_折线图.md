# 📊 折线图功能 - 快速上手指南

## ✨ 功能简介

服务器详情页现在支持显示以下折线图：

- **玩家人数** - 最近 24 小时的在线玩家数变化
- **延迟** - 最近 24 小时的服务器延迟变化

图表数据由后台自动收集，每 5 分钟更新一次。

---

## 🚀 快速开始

### 方法 1：使用测试数据（推荐用于快速测试）

1. **打开设置页面**
   - 点击底部导航栏的"设置"图标

2. **生成测试数据**
   - 滚动到"开发者选项"部分
   - 点击"生成测试数据"
   - 确认生成

3. **查看折线图**
   - 返回主页
   - 点击任意服务器卡片进入详情页
   - 向下滚动查看玩家人数和延迟折线图

4. **效果**
   - 立即看到包含 144 个数据点的完整折线图
   - 模拟真实服务器使用模式（凌晨人少，下午/晚上人多）

### 方法 2：使用真实数据（推荐用于生产环境）

1. **添加服务器**
   - 在主页点击"+"按钮添加 Minecraft 服务器

2. **等待数据收集**
   - 应用会自动开始收集数据
   - 每 5 分钟收集一次
   - 建议等待至少 30 分钟以获得有意义的图表

3. **查看折线图**
   - 点击服务器卡片进入详情页
   - 查看实时更新的折线图

---

## 📖 详细说明

### 自动数据收集

**启动时机**：

- 应用启动时自动为所有服务器启动数据收集
- 添加新服务器时立即开始收集
- 编辑服务器后根据需要重启收集
- 删除服务器时停止收集

**收集频率**：

- 默认：每 5 分钟一次
- 可调整（修改代码中的 `intervalMinutes` 参数）

**数据保留**：

- 自动保留最近 24 小时的数据
- 超过 24 小时的数据会被自动清理
- 最多保留 2000 个数据点

### 折线图特性

**玩家人数图表**：

- X 轴：0-23 小时
- Y 轴：玩家数量（默认最大 70，可调整）
- 颜色：蓝色渐变
- 显示：平滑曲线 + 区域填充

**延迟图表**：

- X 轴：0-23 小时
- Y 轴：延迟时间（ms，默认最大 200ms）
- 颜色：绿色渐变
- 显示：平滑曲线 + 区域填充

**交互功能**：

- 悬停/点击显示具体数值
- 自动缩放和平移
- 平滑动画效果

---

## ⚙️ 配置选项

### 修改收集间隔

编辑 `lib/pages/home_page.dart` 中的 `_startDataCollection()` 方法：

```dart
void _startDataCollection() {
  DataCollectorService().startCollectingForAllServers(db.items);
  // 或者为单个服务器自定义间隔
  // DataCollectorService().startCollecting(
  //   address: 'mc.example.com',
  //   port: 25565,
  //   intervalMinutes: 10, // 改为 10 分钟
  // );
}
```

### 修改图表 Y 轴范围

编辑 `lib/pages/server_detail_page.dart` 中的 `_buildChartCard` 调用：

```dart
// 玩家人数图表
_buildChartCard(
  context,
  title: l10n.playerCount,
  subtitle: l10n.last24Hours,
  data: _getPlayerCountData(),
  color: Colors.blue,
  unit: l10n.players,
  maxY: 100, // 修改为 100
),

// 延迟图表
_buildChartCard(
  context,
  title: l10n.pingLatency,
  subtitle: l10n.last24Hours,
  data: _getLatencyData(),
  color: Colors.green,
  unit: l10n.ms,
  maxY: 300, // 修改为 300ms
),
```

---

## 🛠️ 开发者选项

### 生成测试数据

**用途**：

- 快速测试折线图功能
- 演示应用效果
- 开发调试

**生成的数据**：

- 过去 24 小时，每 10 分钟一个数据点（共 144 个）
- 模拟真实使用模式：
  - 凌晨 (0-6点)：2-10 人在线
  - 上午 (6-12点)：10-30 人在线
  - 下午 (12-18点)：35-60 人在线
  - 晚上 (18-22点)：40-70 人在线
  - 深夜 (22-24点)：15-35 人在线
- 延迟：10-100ms，偶尔会有较高延迟

**操作步骤**：

1. 设置 → 开发者选项 → 生成测试数据
2. 确认生成
3. 查看服务器详情页

### 清除历史数据

**用途**：

- 清除所有测试数据
- 重新开始数据收集
- 释放存储空间

**注意**：

- ⚠️ 此操作不可恢复！
- 会清除所有服务器的历史数据
- 不会删除服务器配置

---

## 📝 故障排查

### 折线图为空或没有数据

**可能原因**：

1. 刚添加服务器，数据还未收集
2. 服务器离线，无法获取数据
3. 数据收集服务未启动

**解决方法**：

1. **检查服务器状态**：确认服务器在线
2. **等待数据收集**：至少等待 10-15 分钟
3. **使用测试数据**：在设置中生成测试数据快速验证
4. **重启应用**：关闭并重新打开应用

### 图表显示异常

**可能原因**：

1. Y 轴范围设置不合适
2. 数据点过多或过少
3. 数据格式错误

**解决方法**：

1. **调整 Y 轴范围**：修改 `maxY` 参数
2. **查看数据**：使用开发者工具查看 Hive 中存储的数据
3. **清除数据**：清除历史数据后重新生成

### 数据不更新

**可能原因**：

1. 数据收集服务已停止
2. 服务器连接失败
3. 应用在后台被系统终止

**解决方法**：

1. **重启应用**：确保数据收集服务重新启动
2. **检查网络**：确认网络连接正常
3. **查看日志**：查看控制台输出的错误信息

---

## 💡 最佳实践

1. **推荐配置**：
   - 服务器数量：3-10 个
   - 收集间隔：5 分钟（默认）
   - Y 轴范围：根据实际服务器容量调整

2. **性能优化**：
   - 服务器较多时（>10 个），建议增加收集间隔到 10-15 分钟
   - 定期清理无用的历史数据
   - 避免频繁刷新详情页

3. **数据质量**：
   - 确保服务器地址和端口正确
   - 定期检查服务器在线状态
   - 收集至少 2-3 小时的数据以获得有意义的趋势

---

## 📚 相关文件

```
lib/
├── services/
│   ├── data_collector.dart          # 数据收集服务
│   ├── test_data_generator.dart     # 测试数据生成器
│   └── minecraft_server_status.dart # 服务器状态查询
├── pages/
│   ├── home_page.dart                # 主页（启动数据收集）
│   ├── server_detail_page.dart       # 详情页（显示折线图）
│   └── setting_page.dart             # 设置页（开发者选项）
└── data/
    └── database.dart                  # 数据库操作
```

---

## 🎯 下一步

1. **体验功能**：
   - 生成测试数据查看效果
   - 添加真实服务器开始收集

2. **自定义配置**：
   - 根据需求调整收集间隔
   - 修改图表显示范围

3. **监控数据**：
   - 定期查看折线图
   - 分析服务器使用模式

---

## ❓ 需要帮助？

如遇问题，请检查：

1. 服务器地址和端口是否正确
2. 网络连接是否正常
3. 数据收集服务是否正常运行
4. 控制台是否有错误信息

或者在设置页面尝试：

- 生成测试数据验证功能
- 清除历史数据重新开始
