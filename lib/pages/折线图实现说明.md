# 折线图实现说明

## 功能概述

已成功实现服务器详情页的折线图功能，包括：

1. **自动数据收集服务** (`data_collector.dart`)
   - 每 5 分钟自动收集一次服务器状态
   - 收集玩家人数和延迟信息
   - 自动保存到 Hive 数据库
   - 保留最近 24 小时的数据

2. **数据存储**
   - 使用 Hive 数据库存储历史数据
   - 数据格式：`{'timestamp': 时间戳, 'players': 玩家数, 'latency': 延迟}`
   - Key: `history_{address}_{port}`

3. **折线图显示**
   - 玩家人数折线图
   - 延迟折线图
   - X 轴：0-23 小时
   - Y 轴：动态数据

## 使用方法

### 自动启动

应用启动时会自动为所有已添加的服务器启动数据收集。

### 添加新服务器

添加新服务器后，会自动启动该服务器的数据收集。

### 删除服务器

删除服务器后，会自动停止该服务器的数据收集。

### 编辑服务器

如果修改了服务器地址或端口，会自动停止旧的数据收集，并启动新的数据收集。

## 数据收集间隔

默认每 5 分钟收集一次数据。可以通过修改 `home_page.dart` 中 `_startDataCollection()` 方法的参数来调整：

```dart
DataCollectorService().startCollecting(
  address: address, 
  port: port,
  intervalMinutes: 5, // 修改这里的值来改变收集间隔
);
```

## 注意事项

1. **等待数据累积**
   - 首次添加服务器后，折线图可能为空
   - 需要等待数据收集服务运行一段时间（至少 5 分钟）
   - 建议等待 1-2 小时以获得更好的图表效果

2. **数据保留时间**
   - 自动保留最近 24 小时的数据
   - 超过 24 小时的旧数据会被自动清除

3. **性能考虑**
   - 如果服务器数量较多，建议增加收集间隔
   - 默认间隔（5 分钟）适合 3-10 个服务器

## 自定义配置

### 修改收集间隔

在 `home_page.dart` 的 `_startDataCollection()` 方法中：

```dart
void _startDataCollection() {
  for (var item in db.items) {
    final address = item['address'];
    final port = int.tryParse(item['port'] ?? '25565');
    if (address != null && port != null) {
      DataCollectorService().startCollecting(
        address: address,
        port: port,
        intervalMinutes: 10, // 改为 10 分钟收集一次
      );
    }
  }
}
```

### 清除历史数据

可以通过 `DataCollectorService` 清除指定服务器的历史数据：

```dart
DataCollectorService().clearHistory('mc.example.com', 25565);
```

### 查看数据数量

可以查看指定服务器已收集的数据点数量：

```dart
int count = DataCollectorService().getHistoryCount('mc.example.com', 25565);
print('已收集 $count 个数据点');
```

## 文件结构

```
lib/
├── services/
│   ├── data_collector.dart       # 数据收集服务
│   └── minecraft_server_status.dart
├── pages/
│   ├── home_page.dart             # 主页（集成了数据收集）
│   └── server_detail_page.dart    # 详情页（显示折线图）
└── data/
    └── database.dart
```

## 测试建议

1. **添加一个测试服务器**
   - 地址：localhost 或一个公开的 MC 服务器

2. **等待数据收集**
   - 等待至少 30 分钟
   - 查看 server_detail_page 的折线图

3. **验证数据更新**
   - 每 5 分钟应该会有新的数据点
   - 图表应该会实时更新

## 故障排查

### 折线图为空

1. 检查服务器是否在线
2. 等待至少 5-10 分钟让数据收集
3. 确认数据收集服务已启动
4. 查看控制台是否有错误信息

### 数据收集不工作

1. 确认服务器地址和端口正确
2. 检查网络连接
3. 确认 `DataCollectorService` 已正确初始化

### 图表显示异常

1. 检查 Y 轴的 `maxY` 值是否合适
2. 确认数据格式正确
3. 查看是否有数据点超出显示范围
